<?php
include_once "../model/database.class.php";
include_once "../model/pregunta.class.php";
include_once "../model/respuesta.class.php";

// Recibimos el mensaje del usuario vÃ­a POST
$mensajeUsuario = trim($_POST['mensaje'] ?? "");

// Inicializamos la respuesta del bot
$respuestaBot = "No entendÃ­ tu pregunta ðŸ¤”";

// Buscar la pregunta exacta (o podÃ©s implementar bÃºsqueda mÃ¡s avanzada)
$preguntas = Preguntas::obtenerTodas();
$preguntaEncontrada = null;

foreach ($preguntas as $p) {
    if (strcasecmp($p['pregunta'], $mensajeUsuario) === 0) {
        $preguntaEncontrada = $p;
        break;
    }
}

if ($preguntaEncontrada) {
    $respuestas = Respuesta::obtenerPorId($preguntaEncontrada['id']);
    if ($respuestas && count($respuestas) > 0) {
        $respuestaBot = $respuestas[0]['respuesta'];
    }
}


// ðŸ”¹ Guardar la conversaciÃ³n usando tu controller existente
$_POST['operacion'] = 'guardar';
$_POST['pregunta_usuario'] = $mensajeUsuario;
$_POST['respuesta_bot'] = $respuestaBot;

include_once "conversacion.controller.php";

// ðŸ”¹ Devolver respuesta al frontend como JSON
echo json_encode([
    "usuario" => $mensajeUsuario,
    "bot" => $respuestaBot
]);
